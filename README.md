# Курсовая работа №1
## Описание проекта
Данный проект предназначен для анализа финансовых транзакций, хранящихся в Excel-файлах. 
Приложение автоматически обрабатывает данные транзакций, формирует отчеты в различных форматах (JSON, Excel) и предоставляет удобные сервисы для поиска и анализа транзакций по заданным параметрам. 
Система гибко интегрируется с веб-интерфейсами и поддерживает расширяемость за счет использования модульной архитектуры, логирования и тестирования.

В проекте так же реализвано логирование с помощью библиотеки `logging`, все результаты логирования записываются в файлы

## Инструкция по установке
Для использования функций из этого проекта, необходимо клонировать репозиторий и установить необходимые зависимости.

1. Клонируйте репозиторий:
```bash
git clone https://github.com/Gabdulla-Khakiev/Project_1
cd Project_1
```
2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

## Использование:

## Веб-страницы: Главная

### Чтение данных `file_readers.py`
Чтение транзакций из Excel
Функция `read_transactions_from_excel(file_path: str) -> list` читает данные из Excel-файла и возвращает их в виде списка словарей. 
Если файл не найден или возникла ошибка при чтении, функция возвращает пустой список и записывает сообщение об ошибке в лог.

Пример использования:
```python
from file_readers import read_transactions_from_excel

file_path = "your_file.xlsx" # Заменить на название своего файла
transactions = read_transactions_from_excel(file_path)
print(transactions)  # Вывод: список транзакций в формате словарей
```

### Утилиты для обработки данных `utils.py`
#### Приветствие по времени суток
Функция `get_greeting(current_time: datetime) -> str` возвращает соответствующее приветствие в зависимости от времени суток (Доброе утро, Добрый день, Добрый вечер, Доброй ночи). 
Логируется текущее время и выбранное приветствие.

Пример использования:
```python
from utils import get_greeting
from datetime import datetime

current_time = datetime.now()
greeting = get_greeting(current_time)
print(greeting)  # Вывод: Добрый день (или другое в зависимости от времени)
```
#### Обработка данных по картам
Функция `process_card_data(transactions: list) -> list` обрабатывает данные транзакций, возвращает информацию о каждой карте: 
последние 4 цифры карты, общая сумма расходов и кэшбэк. Логируются данные по каждой карте и общее количество обработанных карт.

Пример использования:
```python
from utils import process_card_data

transactions = [
    {"Номер карты": "1234567812345678", "Сумма операции с округлением": 5000, "Категория": "Покупки"},
    {"Номер карты": "9876543210987654", "Сумма операции с округлением": 10000, "Категория": "Транспорт"},
]
card_data = process_card_data(transactions)
print(card_data)
```
#### Топ-5 транзакций
Функция `get_top_5_transactions(transactions: list) -> list` сортирует транзакции по сумме и возвращает топ-5 самых крупных транзакций. 
Логируется процесс сортировки и результат.

Пример использования:
```python
from utils import get_top_5_transactions

transactions = [
    {"Дата платежа": "2023-09-01", "Сумма операции с округлением": 1500, "Категория": "Покупки", "Описание": "Магазин"},
    {"Дата платежа": "2023-09-02", "Сумма операции с округлением": 2500, "Категория": "Транспорт", "Описание": "Такси"},
]
top_5 = get_top_5_transactions(transactions)
print(top_5)
```

### Взаимодействие с внешними API `external_api.py`
#### Получение курса валют
Функция `get_exchange_rate(from_currency: str, to_currency: str = "RUB") -> dict` 
выполняет запрос к Exchange Rates Data API для получения текущего курса валюты.
Возвращает базовую валюту и курс конвертации. Логируется успешный запрос или ошибка при выполнении запроса.

Пример использования:
```python
from external_api import get_exchange_rate

exchange_rate = get_exchange_rate("USD")
print(exchange_rate)  # Вывод: {'base': 'USD', 'rates': 75.36}
```
#### Получение стоимости акций S&P 500
Функция `get_sp500_stock_price(symbol: str) -> dict` выполняет запрос к API Alpha Vantage для получения текущей стоимости акции S&P 500 по заданному символу.
Возвращает символ акции и её текущую стоимость. Логируется успешный запрос или ошибка при выполнении запроса.

Пример использования:
```python
from external_api import get_sp500_stock_price

stock_price = get_sp500_stock_price("AAPL")
print(stock_price)  # Вывод: {'stock': 'AAPL', 'price': '145.09'}
```

### Генерация отчетов и данных для веб-страниц `views.py`
#### Загрузка пользовательских настроек
Функция `load_user_settings(file_path: str) -> dict` загружает пользовательские настройки из JSON-файла, такие как выбранные валюты и акции для анализа. 
Логируется информация о загрузке настроек или ошибки при чтении файла.

Пример использования:
```python
from views import load_user_settings

settings = load_user_settings('data/user_settings.json')
print(settings)
```
#### Формирование диапазона дат
Функция `get_date_range(date_str: str) -> tuple` возвращает диапазон дат с начала месяца до указанной даты, 
указанной в строковом формате. Это используется для фильтрации данных по определенным периодам.

Пример использования:
```python
from views import get_date_range

start_date, end_date = get_date_range('2023-09-15')
print(start_date, end_date)  # Вывод: 2023-09-01 00:00:00, 2023-09-15 00:00:00
```
#### Генерация отчета
Функция `generate_report(datetime_str: str, transactions: list) -> str` формирует JSON-ответ, содержащий приветствие, информацию по картам, топ-5 транзакций, курсы валют и стоимость акций из S&P 500. 
Логируется процесс генерации отчета, и результат возвращается в формате JSON.

Пример использования:
```python
from views import generate_report
from file_readers import read_transactions_from_excel

transactions = read_transactions_from_excel('transactions.xlsx')
report = generate_report('2023-09-15', transactions)
print(report)  # Вывод: JSON-ответ с информацией по картам, транзакциям, валютам и акциям
```
Пример JSON ответа:
```json
{
  "greeting": "Добрый день",
  "cards": [
    {
      "last_digits": "5814",
      "total_spent": 1262.00,
      "cashback": 12.62
    },
    {
      "last_digits": "7512",
      "total_spent": 7.94,
      "cashback": 0.08
    }
  ],
  "top_transactions": [
    {
      "date": "21.12.2021",
      "amount": 1198.23,
      "category": "Переводы",
      "description": "Перевод Кредитная карта. ТП 10.2 RUR"
    },
    {
      "date": "20.12.2021",
      "amount": 829.00,
      "category": "Супермаркеты",
      "description": "Лента"
    },
    {
      "date": "20.12.2021",
      "amount": 421.00,
      "category": "Различные товары",
      "description": "Ozon.ru"
    },
    {
      "date": "16.12.2021",
      "amount": -14216.42,
      "category": "ЖКХ",
      "description": "ЖКУ Квартира"
    },
    {
      "date": "16.12.2021",
      "amount": 453.00,
      "category": "Бонусы",
      "description": "Кешбэк за обычные покупки"
    }
  ],
  "currency_rates": [
    {
      "currency": "USD",
      "rate": 73.21
    },
    {
      "currency": "EUR",
      "rate": 87.08
    }
  ],
  "stock_prices": [
    {
      "stock": "AAPL",
      "price": 150.12
    },
    {
      "stock": "AMZN",
      "price": 3173.18
    },
    {
      "stock": "GOOGL",
      "price": 2742.39
    },
    {
      "stock": "MSFT",
      "price": 296.71
    },
    {
      "stock": "TSLA",
      "price": 1007.08
    }
  ]
}
```
## Сервисы

### Поиск номеров телефонов в транзакциях `services.py`
#### Поиск номеров телефонов
Функция `find_phone_numbers(transactions: list) -> str` использует регулярные выражения для поиска номеров телефонов в описаниях транзакций. 
Если номер телефона найден, транзакция добавляется в результат, который возвращается в формате JSON. 
В процессе работы функции осуществляется логирование найденных номеров и общего количества транзакций с номерами телефонов.

Пример использования:
```python
from services import find_phone_numbers

transactions = [
    {"Описание": "Я МТС +7 921 11-22-33", "Сумма операции": -300},
    {"Описание": "Тинькофф Мобайл +7 995 555-55-55", "Сумма операции": -500},
    {"Описание": "Покупка в магазине", "Сумма операции": -1000}
]

phone_transactions = find_phone_numbers(transactions)
print(phone_transactions)
```
## Отчеты

### Отчеты по тратам `reports.py`
#### Сохранение отчета в файл
Декоратор `save_report_to_file(filename: str = None)` позволяет сохранять результат функции-отчета в JSON-файл. 
Если имя файла не указано, используется имя по умолчанию с временной меткой. Логируется информация о сохранении отчета в файл.

Пример использования:
```python
from reports import save_report_to_file

@save_report_to_file()  # Сохранение отчета по умолчанию
def some_report():
    return {"data": "example"}
```
#### Траты по категории за последние три месяца
Функция `spending_by_category(transactions: pd.DataFrame, category: str, date: Optional[str] = None) -> dict` возвращает траты по указанной категории за последние три месяца от переданной даты. 
Если дата не передана, используется текущая дата. Результат возвращается в виде словаря, который также сохраняется в файл благодаря декоратору.

Пример использования:
```python
from reports import spending_by_category
import pandas as pd

data = {
    "Дата операции": ["2023-06-01", "2023-07-15", "2023-08-20", "2023-09-01"],
    "Категория": ["Продукты", "Продукты", "Развлечения", "Продукты"],
    "Сумма операции": [-1500.0, -2000.0, -500.0, -1000.0]
}

transactions = pd.DataFrame(data)
report = spending_by_category(transactions, "Продукты", "2023-09-15")
print(report)
```

## Тестирование

В данном проекте реализованы автоматизированные тесты, которые обеспечивают надежность и стабильность функциональности приложения. Тесты написаны с использованием библиотеки pytest и включают как модульные, так и интеграционные тесты. Основные аспекты тестирования:

+ Фикстуры: Используются для настройки общих данных, необходимых для тестов, что позволяет сократить дублирование кода.

+ Параметризация: Позволяет запускать одни и те же тесты с различными наборами данных, обеспечивая более полное покрытие функциональности.

+ Mocking и Patching: Используются для имитации работы внешних API и других зависимостей, что позволяет тестировать бизнес-логику без обращения к реальным ресурсам.

+ Запуск тестов: Для выполнения тестов можно использовать команду `pytest`, которая автоматически обнаруживает и выполняет тесты в проекте.
Данные тесты помогают убедиться в корректности работы приложения и позволяют легко выявлять и исправлять ошибки в коде.

Запуск тестов:
```bash
pytest tests/ 
```
